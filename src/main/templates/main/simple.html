{% extends 'main/base.html' %}
{% load static %}
{% load i18n %}
{% block sub-title %}liveness report{% endblock %}

{% block style %}{% endblock %}

{% block content %}



    <div class="container">

      <div class="row head">
        <div class="center">{{ last|date:'m.d H:i:s' }}</div>
      </div>
      <div class="row">

        <div class="input-field col s5">
          <select id="id-device">
            {% for item in device_names %}
              <option {% if item.name == device_name %}selected{% endif %}  value="{{ item.name }}">{{ item.name }}</option>
            {% endfor %}
          </select>
          <label>Устройство</label>
        </div>

        <div class="input-field col s4">
          <select id="id-min-per-interval">
            <option {% if min_per_interval == 10 %}selected{% endif %} value="10">10</option>
            <option {% if min_per_interval == 20 %}selected{% endif %} value="20">20</option>
            <option {% if min_per_interval == 30 %}selected{% endif %} value="30">30</option>
            <option {% if min_per_interval == 60 %}selected{% endif %} value="60">60</option>
          </select>
          <label>Масштаб (мин.)</label>
        </div>

        <div class="input-field col s3 right-align">
          <a id="id-apply" class="waves-effect waves-light btn">ок</a>
        </div>

      </div>

      <div class="row report">
        <table class="report">
          {% for day in intervals %}
            <tr class="day">
              {% for item in day %}
                <td class="pietd {% if item.percent > 0 %}clickable{% endif %} " title="{{ item.hint }}"><div class="pie" data-percent="{{ item.percent_str }}"></div></td>
              {% endfor %}
            </tr>
          {% endfor %}
        </table>
      </div>

    </div>

{% endblock %}

{% block extrajs %}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      M.AutoInit();

      document.getElementById("id-apply").addEventListener('click', function(){
        var elems = document.querySelectorAll('select');
        var instances = M.FormSelect.init(elems);

        let deviceCtl =  M.FormSelect.getInstance(document.getElementById("id-device"));
        let intervalCtl = M.FormSelect.getInstance(document.getElementById("id-min-per-interval"));

        let deviceName = deviceCtl.getSelectedValues()[0]
        let minPerInt = intervalCtl.getSelectedValues()[0]

        document.location = `/main/livenessreport/${deviceName}/${minPerInt}`
      })

      document.querySelectorAll("td.clickable").forEach(
        function(item){
          item.addEventListener('click', function(){
            M.toast({html: "<pre class='toast-msg'>"  + item.title + "</pre>"});
          });
        }
      );

      drawPies()
    });

    function drawPies(){
      {#<div class="pie" data-percent="60"></div>#}
      const PIE_SIZE = 12

      let ps2 = PIE_SIZE/2

      let elems = document.querySelectorAll('.pie');
      for (let elem of elems) {
        elem.innerHTML=`<canvas class="pie-canvas" width="${PIE_SIZE}" height="${PIE_SIZE}"></canvas>`

        let percent = elem.dataset.percent
        let ostatok = 100 - percent
        let cnvs = elem.querySelector(".pie-canvas")
        let ctx = cnvs.getContext("2d");

        let currentAngle = 0;
        const results = [
          {total: percent, colour: "green"},
          {total: ostatok, colour: "#fcc6c6"},
        ];
        for (let percentValues of results) {
          let portionAngle = (percentValues.total / 100) * 2 * Math.PI;
          ctx.beginPath();
          ctx.arc(ps2, ps2, ps2, currentAngle, currentAngle + portionAngle);
          currentAngle += portionAngle;
          ctx.lineTo(ps2, ps2);
          ctx.fillStyle = percentValues.colour;
          ctx.fill();
        }
      }
    }
  </script>
{% endblock %}


